# 使用Angular指令实现权限控制
公司已有的代理商管理系统，权限控制需要调整，由我负责前端相关工作，此文记录一下修改过程。  

## 原有实现
前端原有的权限控制是基于角色的，根据当前登录账号的角色，控制菜单及功能入口的显示状态。前端主要技术用到Angular，以及使用angular-ui-router实现不同业务逻辑的相对分离，在这种技术前提下，原有的权限控制实现方式大致如下：

> 在`mainController`中获取当前登录用户的角色，并将其赋值到`$rootScope.role`，页面或其他`controller`中则使用该变量（`$rootScope.role`）去做基于角色的相关权限控制。  

按照上述实现方式，页面上通过`<div ng-show="role === ?">...</div>`等类似方式，达到不同角色显示不同内容的效果。但由于不详原因，存在这样一种情况：  

> 本是相同性质的接口，却按角色不同，拆分成了不同接口。比如日志查询，root调用的是`/logs/findAllLogs`，agent调用的是`/logs/findAgentLogs`  

这应该是系统设计时犯的一个低级错误，分权分域，域和权的混淆。为处理上述情况，在其他`controller`中也经常也需要`$rootScope`上的角色信息，并且需要考虑异步问题，即当前`controller`中依赖角色信息的逻辑，需要等待`mainController`中获取角色信息成功后才能开始执行。  

上述实现还有一个根本性问题，前端权限控制严重依赖系统固有角色，极度僵硬。原有的丑陋实现之所以能够存在，跟技术人员的水平有关系，同时也因为初期系统比较简单，只包含3个角色：root、agent、user，随着系统增加功能，角色与权限都需要再细分，因此需要重新设计与实现前端的权限控制。  

## 新方案
要解决上述问题，核心就是权限的控制不应依赖角色，而是依赖登录账号所拥有的权限项，要求后台提供接口获取当前登录账号的权限项。其次，因分权分域混淆，导致同性质接口出现多个的情况，要求后台将多个接口合并为一个接口。这两点满足后，接下来就只需考虑前端实现了。  

实现方式完全可以参照原有实现，只需要将角色概念替换成权限项。获取账号权限项，赋值给`$rootScope.permissions`，提供是否拥有权限的判断方法`$rootScope.permissionContain = function (item) {...};`。剩下的都是体力活，删除页面上跟`role`相关的逻辑，再按照新的方式为页面上的功能绑定权限项。  

虽然参照原有方式实现没啥明显缺陷，但自己对于Angular不算很熟，基于探索和学习的精神，打算使用自定义指令达到同样功能，同时了解如何实现Angular自定义指令。

## 指令的实现思路
